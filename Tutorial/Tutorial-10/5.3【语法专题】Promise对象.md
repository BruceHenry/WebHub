### 5.3 Promise对象
[教程地址： 5.3 Promise对象](http://javascript.ruanyifeng.com/advanced/promise.html)

---
```
1. JavaScript的异步执行
   1.1 概述
   1.2 回调函数
   1.3 事件监听
   1.4 发布/订阅
2. 异步操作的流程控制
   2.1 串行执行
   2.2 并行执行
   2.3 并行与串行的结合
3. Promise对象
   3.1 简介
   3.2 Promise接口
   3.3 Promise对象的生成
   3.4 用法辨析
4. Promise的应用
   4.1 加载图片
   4.2 Ajax操作
   4.3 小结
5. 参考链接
```

- Promise是JavaScript异步操作解决方案

---
### 1. JavaScript的异步执行

#### 1.1 概述
- ”同步模式”就是传统做法，后一个任务等待前一个任务结束，然后再执行，程序的执行顺序与任务的排列顺序是一致的、同步的。这往往用于一些简单的、快速的、不涉及读写的操作
- “异步模式”则完全不同，每一个任务分成两段，第一段代码包含对外部数据的请求，第二段代码被写成一个回调函数，包含了对外部数据的处理。第一段代码执行完，不是立刻执行第二段代码，而是将程序的执行权交给第二个任务。等到外部数据返回了，再由系统通知执行第二段代码。所以，程序的执行顺序与任务的排列顺序是不一致的、异步的

#### 1.2  回调函数
- 回调函数是异步编程最基本的方法
- 回调函数的优点是简单、容易理解和部署，缺点是不利于代码的阅读和维护，各个部分之间高度耦合（Coupling），使得程序结构混乱、流程难以追踪（尤其是回调函数嵌套的情况），而且每个任务只能指定一个回调函数


#### 1.3 事件监听
- 另一种思路是采用事件驱动模式。任务的执行不取决于代码的顺序，而取决于某个事件是否发生
- 事件监听这种方法的优点是比较容易理解，可以绑定多个事件，每个事件可以指定多个回调函数，而且可以去耦合，有利于实现模块化。缺点是整个程序都要变成事件驱动型，运行流程会变得很不清晰

#### 1.4 发布/订阅
- “事件”完全可以理解成”信号”，如果存在一个”信号中心”，某个任务执行完成，就向信号中心”发布”（publish）一个信号，其他任务可以向信号中心”订阅（subscribe）这个信号，从而知道什么时候自己可以开始执行。这就叫做”发布/订阅模式publish-subscribe pattern），又称观察者模式（observer pattern）
- 这种方法的性质与”事件监听”类似，但是明显优于后者。因为我们可以通过查看”消息中心”，了解存在多少信号、每个信号有多少订阅者，从而监控程序的运行

---
### 2. 异步操作的流程控制
- 如果有多个异步操作，就存在一个流程控制的问题：确定操作执行的顺序，以后如何保证遵守这种顺序

#### 2.1  串行执行
- 我们可以编写一个流程控制函数，让它来控制异步任务，一个任务完成以后，再执行另一个。这就叫串行执行

#### 2.2 并行执行
- 流程控制函数也可以是并行执行，即所有异步任务同时执行，等到全部完成以后，才执行final函数
- 并行执行的好处是效率较高，比起串行执行一次只能执行一个任务，较为节约时间。但是问题在于如果并行的任务较多，很容易耗尽系统资源，拖慢运行速度。因此有了第三种流程控制方式

#### 2.3 并行与串行的结合
- 所谓并行与串行的结合，就是设置一个门槛，每次最多只能并行执行n个异步任务。这样就避免了过分占用系统资源

---
### 3. Promise对象

#### 3.1 简介
- Promise对象是CommonJS工作组提出的一种规范，目的是为异步操作提供统一接口
- 首先，它是一个对象，也就是说与其他JavaScript对象的用法，没有什么两样；其次，它起到代理作用（proxy），充当异步操作与回调函数之间的中介。它使得异步操作具备同步操作的接口，使得程序具备正常的同步运行的流程，回调函数不必再一层层嵌套
- 简单说，它的思想是，每一个异步任务立刻返回一个Promise对象，由于是立刻返回，所以可以采用同步操作的流程
- 这个Promises对象有一个then方法，允许指定回调函数，在异步任务完成后调用
- 总的来说，传统的回调函数写法使得代码混成一团，变得横向发展而不是向下发展。Promises规范就是为了解决这个问题而提出的，目标是使用正常的程序流程（同步），来处理异步操作
- Promises原本只是社区提出的一个构想，一些外部函数库率先实现了这个功能。ECMAScript 6将其写入语言标准，因此目前JavaScript语言原生支持Promise对象

#### 3.2 Promise接口
- Promise对象只有三种状态
   *   异步操作“未完成”（pending）
   *   异步操作“已完成”（resolved，又称fulfilled）
   *   异步操作“失败”（rejected）
- 这三种的状态的变化途径只有两种
   *   异步操作从“未完成”到“已完成”
   *   异步操作从“未完成”到“失败”
- 这种变化只能发生一次，一旦当前状态变为“已完成”或“失败”，就意味着不会再有新的状态变化了。因此，Promise对象的最终结果只有两种
   *   步操作成功，Promise对象传回一个值，状态变为`resolved`
   *   异步操作失败，Promise对象抛出一个错误，状态变为`rejected`

- Promise对象使用`then`方法添加回调函数。`then`方法可以接受两个回调函数，第一个是异步操作成功时（变为`resolved`状态）时的回调函数，第二个是异步操作失败（变为`rejected`）时的回调函数（可以省略）。一旦状态改变，就调用相应的回调函数
- 这就是说，Promises对象的错误有传递性

#### 3.3 Promise对象的生成
- ES6提供了原生的Promise构造函数，用来生成Promise实例
- Promise构造函数接受一个函数作为参数，该函数的两个参数分别是`resolve`和`reject`。它们是两个函数，由JavaScript引擎提供，不用自己部署

#### 3.4 用法辨析
- Promise的用法，简单说就是一句话：使用`then`方法添加回调函数

---
### 4. Promise的应用

#### 4.1 加载图片
- 我们可以把图片的加载写成一个`Promise`对象

#### 4.2 Ajax操作
- Ajax操作是典型的异步操作，传统上往往写成下面这样

#### 4.3 小节
- Promise对象的优点在于，让回调函数变成了规范的链式写法，程序流程可以看得很清楚。它的一整套接口，可以实现许多强大的功能，比如为多个异步操作部署一个回调函数、为多个回调函数中抛出的错误统一指定处理方法等等
- 而且，它还有一个前面三种方法都没有的好处：如果一个任务已经完成，再添加回调函数，该回调函数会立即执行。所以，你不用担心是否错过了某个事件或信号。这种方法的缺点就是，编写和理解都相对比较难
